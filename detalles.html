<script>
  /* -------- Firebase ---------- */
  firebase.initializeApp({
    apiKey: "AIzaSyCmMqUkiT_8zTdJYIfhs2VneW9p_33vow4",
    authDomain: "atomix-54e1a.firebaseapp.com",
    projectId: "atomix-54e1a"
  });
  const db = firebase.firestore();

  const tituloParam = new URLSearchParams(location.search).get('titulo') || '';
  const $hero = document.getElementById('hero');
  const $play = document.getElementById('playBtn');
  const $modal = document.getElementById('modalPlayer');
  const $video = document.getElementById('player');
  const $titulo = document.getElementById('titulo');
  const $anio = document.getElementById('anio');
  const $punt = document.getElementById('puntuacion');
  const $sin = document.getElementById('sinopsis');

  let videoURL = '';
  let plyr = null;

  if (!tituloParam) {
    $titulo.textContent = 'Película no encontrada';
    $play.style.display = 'none';
  } else {
    db.collection('peliculas').where('titulo', '==', decodeURIComponent(tituloParam)).get()
      .then(snap => {
        if (snap.empty) throw new Error('No existe');
        const p = snap.docs[0].data();
        $titulo.textContent = p.titulo || 'Sin título';
        if (p.anio) $anio.textContent = `Año: ${p.anio}`;
        if (p.puntuacion) $punt.textContent = `⭐ ${p.puntuacion}/10`;
        $sin.textContent = p.sinopsis || 'Sinopsis no disponible.';
        $hero.style.backgroundImage = `url(${p.imagen})`;
        videoURL = p.trailer || p.video || '';
        if (!videoURL) $play.style.display = 'none';
      })
      .catch(e => {
        $titulo.textContent = 'Película no encontrada';
        $play.style.display = 'none';
      });
  }

  /* -------- Abrir player en pantalla completa -------- */
  $play.addEventListener('click', async () => {
    if (!videoURL) return;

    $video.src = videoURL;

    if (plyr) {
      plyr.destroy();
      plyr = null;
    }

    $modal.showModal();

    setTimeout(async () => {
      plyr = new Plyr($video, { autoplay: true });

      try {
        await $video.play();

        // ✅ Pantalla completa sobre el VIDEO directamente
        if ($video.requestFullscreen) await $video.requestFullscreen();
        else if ($video.webkitRequestFullscreen) await $video.webkitRequestFullscreen();
        else if ($video.msRequestFullscreen) await $video.msRequestFullscreen();
      } catch (e) {
        console.warn("No se pudo reproducir automáticamente:", e.message);
      }
    }, 200);
  });

  /* -------- Cerrar modal -------- */
  function cerrarModal() {
    if (document.fullscreenElement) document.exitFullscreen();
    $modal.close();
    $video.pause();

    if (plyr) {
      plyr.destroy();
      plyr = null;
    }

    $video.removeAttribute('src');
    $video.load();
  }

  // Botón cerrar
  document.querySelector('.modal-close').addEventListener('click', cerrarModal);

  // Al terminar el video
  $video.addEventListener('ended', cerrarModal);

  // Teclado
  document.addEventListener('keydown', (e) => {
    if (!$modal.open) return;

    switch (e.key) {
      case 'ArrowLeft':
        $video.currentTime -= 10;
        break;
      case 'ArrowRight':
        $video.currentTime += 10;
        break;
      case ' ':
      case 'Enter':
        e.preventDefault();
        if ($video.paused) $video.play(); else $video.pause();
        break;
      case 'Escape':
      case 'Backspace':
        cerrarModal();
        break;
    }
  });
</script>
